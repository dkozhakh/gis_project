/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var l7Raw = ee.ImageCollection("LANDSAT/LE7_L1T"),
    BU = /* color: #0b4a8b */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[121.49237394332886, 31.241966893004953],
                  [121.49204134941101, 31.241434858111504],
                  [121.49223446846008, 31.241049589593715],
                  [121.49302840232849, 31.241462377231212],
                  [121.49273872375488, 31.242012757941655]]]),
            {
              "landcover": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.49491667747498, 31.24210448774825],
                  [121.49474501609802, 31.241664183864106],
                  [121.49553894996643, 31.24164583782439],
                  [121.49547457695007, 31.24215952558946]]]),
            {
              "landcover": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.4958930015564, 31.240535895792128],
                  [121.49557113647461, 31.24004054555189],
                  [121.49613976478577, 31.239857081840746],
                  [121.49662256240845, 31.240315740450498]]]),
            {
              "landcover": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.48582935333252, 31.240930339495918],
                  [121.48579716682434, 31.240636800152206],
                  [121.48617267608643, 31.24065514638792],
                  [121.48616194725037, 31.240957858762624]]]),
            {
              "landcover": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.48247122764587, 31.24058176142372],
                  [121.48251414299011, 31.24035243304309],
                  [121.48301839828491, 31.24049003013827],
                  [121.48292183876038, 31.2407377044045]]]),
            {
              "landcover": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.4764952659607, 31.23710508341345],
                  [121.47659182548523, 31.23677483821456],
                  [121.47743940353394, 31.23704086915963],
                  [121.47729992866516, 31.237389460298523],
                  [121.47640943527222, 31.23710508341345],
                  [121.47650599479675, 31.236921614001048]]]),
            {
              "landcover": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.47909164428711, 31.237939864740973],
                  [121.47916674613953, 31.237609622460326],
                  [121.47951006889343, 31.23773805015109],
                  [121.47934913635254, 31.238031598502932]]]),
            {
              "landcover": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.47029399871826, 31.236242774076903],
                  [121.47030472755432, 31.23596756731264],
                  [121.47110939025879, 31.236004261594175],
                  [121.47112011909485, 31.23642624480771]]]),
            {
              "landcover": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.47093772888184, 31.23465573738448],
                  [121.47113084793091, 31.234261267480267],
                  [121.47130250930786, 31.234307136158403],
                  [121.47116303443909, 31.234729126952388]]]),
            {
              "landcover": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.45780563354492, 31.231784325792354],
                  [121.45787000656128, 31.231298103688736],
                  [121.45843863487244, 31.2313256257614],
                  [121.4583957195282, 31.231940283295625]]]),
            {
              "landcover": 1,
              "system:index": "9"
            })]),
    NBU = /* color: #ffc82d */ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[121.46703243255615, 31.23388514347959],
                  [121.46707534790039, 31.233224629415837],
                  [121.46772980690002, 31.2335273656016],
                  [121.46742939949036, 31.233967707412894]]]),
            {
              "landcover": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.46033763885498, 31.231004534414804],
                  [121.4604127407074, 31.2308027050099],
                  [121.46061658859253, 31.23088527163675],
                  [121.46057367324829, 31.231105448955606]]]),
            {
              "landcover": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.47373795509338, 31.229444932353886],
                  [121.47384524345398, 31.22911466037951],
                  [121.47408127784729, 31.22911466037951],
                  [121.47388815879822, 31.229481629168678]]]),
            {
              "landcover": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.49313569068909, 31.23213293632662],
                  [121.49336099624634, 31.23152745404937],
                  [121.49374723434448, 31.23179349977026],
                  [121.49344682693481, 31.232288893254484]]]),
            {
              "landcover": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.49232029914856, 31.24650741369479],
                  [121.49204134941101, 31.24611299328276],
                  [121.49259924888611, 31.246002922176086],
                  [121.49279236793518, 31.246479896045088]]]),
            {
              "landcover": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.32356643676758, 31.24122387792738],
                  [121.32354497909546, 31.240416645045784],
                  [121.32474660873413, 31.240545068920238],
                  [121.32466077804565, 31.241407338983805]]]),
            {
              "landcover": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.32993936538696, 31.23740780716495],
                  [121.32978916168213, 31.236692276734427],
                  [121.33028268814087, 31.2365088065203],
                  [121.33056163787842, 31.237261032133855]]]),
            {
              "landcover": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.32826566696167, 31.23511442124857],
                  [121.3284158706665, 31.234527305503477],
                  [121.32933855056763, 31.234802516463272],
                  [121.32916688919067, 31.23531624144328]]]),
            {
              "landcover": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.33169889450073, 31.234288788689827],
                  [121.33180618286133, 31.233720015396575],
                  [121.33287906646729, 31.23401357623354],
                  [121.3326644897461, 31.234527305503477]]]),
            {
              "landcover": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.33942365646362, 31.238453572660557],
                  [121.33942365646362, 31.237316072797235],
                  [121.3400673866272, 31.237316072797235],
                  [121.33993864059448, 31.238508612629097]]]),
            {
              "landcover": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.53170585632324, 31.2522859424759],
                  [121.53273582458496, 31.250745036045743],
                  [121.53582572937012, 31.252506069912993],
                  [121.5336799621582, 31.253459949542773]]]),
            {
              "landcover": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[121.55488014221191, 31.26820716952122],
                  [121.55221939086914, 31.266152968564715],
                  [121.55342102050781, 31.264245456204982],
                  [121.55668258666992, 31.267033345879277]]]),
            {
              "landcover": 0,
              "system:index": "11"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
//centering at Bangkok, Thailand
var roi_Shanghai = ee.Geometry.Point(121.474674768, 31.2411740353);
var buffer_Shanghai = roi_Shanghai.buffer(15000);
Map.addLayer(buffer_Shanghai,{}, "Shanghai");

Map.setCenter(121.474674768,31.2411740353, 10);
//Filtering to 2000, 2005, 2010, 2015 summer
var L7Filtered2015 = l7Raw.filterDate('2015-06-01','2015-08-31').filterBounds(buffer_Shanghai);
var L7Filtered2010 = l7Raw.filterDate('2010-06-01','2010-08-31').filterBounds(buffer_Shanghai);
var L7Filtered2005 = l7Raw.filterDate('2005-06-01','2005-08-31').filterBounds(buffer_Shanghai);
var L7Filtered2000 = l7Raw.filterDate('2000-06-01','2000-08-31').filterBounds(buffer_Shanghai);

Map.addLayer(L7Filtered2000,{},'Shanghai 2000');
Map.addLayer(L7Filtered2005,{},'Shanghai 2005');
//Creating Simple Composite for cleaner image

var l7Composite15= ee.Algorithms.Landsat.simpleComposite({
  collection: L7Filtered2015,
  asFloat: true
});

var l7Composite10= ee.Algorithms.Landsat.simpleComposite({
  collection: L7Filtered2010,
  asFloat: true
});

var l7Composite05= ee.Algorithms.Landsat.simpleComposite({
  collection: L7Filtered2005,
  asFloat: true
});

var l7Composite00= ee.Algorithms.Landsat.simpleComposite({
  collection: L7Filtered2000,
  asFloat: true
});

//Now calculate NDVI, NDWI, NDBI to see what's happeing, train classificator

//NDVI
var ndvi15 = l7Composite15.normalizedDifference(['B4', 'B3']).rename('NDVI');
var ndvi10 = l7Composite10.normalizedDifference(['B4', 'B3']).rename('NDVI');
var ndvi05 = l7Composite05.normalizedDifference(['B4', 'B3']).rename('NDVI');
var ndvi00 = l7Composite00.normalizedDifference(['B4', 'B3']).rename('NDVI');

//NDBI
var ndbi15 = l7Composite15.normalizedDifference(['B5', 'B4']).rename('NDBI');
var ndbi10 = l7Composite10.normalizedDifference(['B5', 'B4']).rename('NDBI');
var ndbi05 = l7Composite05.normalizedDifference(['B5', 'B4']).rename('NDBI');
var ndbi00 = l7Composite00.normalizedDifference(['B5', 'B4']).rename('NDBI');

//NDWI

var ndwi15 = l7Composite15.normalizedDifference(['B2', 'B4']).rename('NDWI');
var ndwi10 = l7Composite10.normalizedDifference(['B2', 'B4']).rename('NDWI');
var ndwi05 = l7Composite05.normalizedDifference(['B2', 'B4']).rename('NDWI');
var ndwi00 = l7Composite00.normalizedDifference(['B2', 'B4']).rename('NDWI');

var landcover = BU.merge(NBU);

//SETTING BANDS
var bands = ['B1', 'B2', 'B3', 'B4', 'B5', 'B6_VCID_2', 'B7', 'NDVI','NDBI','NDWI'];

//Adding bands to composites
var input15 = l7Composite15.addBands(ndvi15).addBands(ndbi15).addBands(ndwi15);
var input10 = l7Composite10.addBands(ndvi10).addBands(ndbi10).addBands(ndwi10);
var input05 = l7Composite05.addBands(ndvi05).addBands(ndbi05).addBands(ndwi05);
var input00 = l7Composite00.addBands(ndvi00).addBands(ndbi00).addBands(ndwi00);

//Creating the training dataset

var training = input15.select(bands).sampleRegions({
collection: landcover,
properties: ['landcover'],
scale: 30
});

//Choosing classifier
var classifier = ee.Classifier.randomForest({numberOfTrees: 22})
.train({
features: training,
classProperty: 'landcover',
inputProperties: bands
});

//Getting trained classifier
var trained = classifier.train(training, 'landcover', bands);

//?????Do I put 'class' or 'landcover' in there???? Well, apparently landcover it is

//Classifying 2015,2010,2005,2000 with 2015 trained classifier

var classified2000 = input00.select(bands).classify(trained);
var classified2005 = input05.select(bands).classify(trained);
var classified2010 = input10.select(bands).classify(trained);
var classified2015 = input15.select(bands).classify(trained);

//Mapping results

Map.addLayer(classified2015.mask(classified2015), {'min':0, 'max':1 , 'palette':'ff133f'},'BU 2015');
Map.addLayer(classified2010.mask(classified2010), {'min':0, 'max':1 , 'palette':'b119ff'},'BU 2010');
Map.addLayer(classified2005.mask(classified2005), {'min':0, 'max':1 , 'palette':'blue'},'BU 2005');
Map.addLayer(classified2000.mask(classified2000), {'min':0, 'max':1 , 'palette':'1dfff4'},'BU 2000');

//Exporting to Assets
Export.image.toAsset({ 
  image: classified2015,
  region: buffer_Bangkok,
  description: 'built-up areas, Shanghai, 2015', assetId: 'BuiltUpAreasShanghai2015',
  scale: 30});
  
//Exporting to Google Drive
Export.image.toDrive(
  {image: classified2015,
    description: 'BU Shanghai,2015',
    fileNamePrefix: 'bu_Shanghai_2015',
    region: buffer_Bangkok,
    scale: 30, 
    maxPixels: 1e9
  });
  
  
  
Map.addLayer(ndbi15,{'min':-0.5197, 'max':0.664},'NDBI 2015');
Map.addLayer(ndbi00,{'min':-0.5197, 'max':0.664},'NDBI 2000');

//Calculate a confusion matrix
var accuracyMatrix = trained.confusionMatrix();
print('Resubstitution error matrix: ', accuracyMatrix);

//Estimate the overall accuracy rate
var overallAccuracy = accuracyMatrix.accuracy();
print('Training overall accuracy: ', overallAccuracy);

//Why is my classifier 100% correct???!!!!


//How big is urban area??? And it's not working...
var urban_Shanghai2015masked = classified2015.mask(classified2015);
var urban_Shanghai2015 = urban_Shanghai2015masked.clip(buffer_Shanghai);

var urbanLandUseArea= urban_Shanghai2015.multiply(ee.Image.pixelArea());

var stats = urbanLandUseArea.reduceRegion(
{
'reducer': ee.Reducer.count(),
'scale': 30,
'geometry': buffer_Shanghai,
'maxPixels': 1e9
});
print(stats);

print('urban area: ' + stats.getInfo() + ' square meters');
